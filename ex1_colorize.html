<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>A Function to Find Complex Entities</title>
    <link href="css/styles.css" type="text/css" rel="stylesheet"/>

    <style>
        #myCanvas {
            width: 100%;
            height: 100%;
            background: lightBlue;
        }

        #my-gui-container {
            position: absolute;
            top: 300px;
            right: 20px;
            z-index: 10;
        }

    </style>


    <script type="text/javascript" src="libs/dat.gui.min.js"></script>

</head>

<body>
<canvas id="myCanvas"></canvas>
<div id="info">
    <h1>Experiment 1</h1><br>
    <p>Colorizing</p><br>
</div>
</body>
<script type="module">

    import {Viewer} from "@xeokit/xeokit-sdk/src/viewer/Viewer.js";
    import {XKTLoaderPlugin} from "@xeokit/xeokit-sdk/src/plugins/XKTLoaderPlugin/XKTLoaderPlugin.js";

    //------------------------------------------------------------------------------------------------------------------
    // Create a Viewer
    //------------------------------------------------------------------------------------------------------------------

    const viewer = new Viewer({
        canvasId: "myCanvas",
        transparent: true
    });

    viewer.camera.eye = [-2.56, 8.38, 8.27];
    viewer.camera.look = [13.44, 3.31, -14.83];
    viewer.camera.up = [0.10, 0.98, -0.14];

    viewer.scene.xrayMaterial.fillColor = [0,0,0];
    viewer.scene.xrayMaterial.fillAlpha = 0.0;
    viewer.scene.xrayMaterial.edgeColor = [0,0,0];
    viewer.scene.xrayMaterial.edgeAlpha = 0.2;

    //----------------------------------------------------------------------------------------------------------------------
    // Create an XKT loader plugin and load a model
    //----------------------------------------------------------------------------------------------------------------------

    const xktLoader = new XKTLoaderPlugin(viewer);

    const model = xktLoader.load({
        id: "myModel",
        src: "./models/xkt/schependomlaan/schependomlaan.xkt",
        metaModelSrc: "./metaModels/schependomlaan/metaModel.json",
        edges: true
    });

    //----------------------------------------------------------------------------------------------------------------------
    // Create some Gantt tasks linked to objects
    //----------------------------------------------------------------------------------------------------------------------

    const tasks = [
        {
            id: 1,
            typeId: "construction",
            start: 1,
            end: 2
        },
        {
            id: 2,
            typeId: "testing",
            start: 1,
            end: 3
        },
        {
            id: 3,
            typeId: "construction",
            start: 2,
            end: 3
        }
    ];

    const types = {
        "construction": {
            color: [1, 0, 0]
        },
        "testing": {
            color: [0, 0, 1]
        },
        "complete": {
            color: [0, 1, 0]
        }
    };

    const links = [
        {
            linkId: 1,
            taskId: 1,
            objectId: "1VvzV9bwH6dB75qr1$srOX" // IfcStair
        },
        {
            linkId: 2,
            taskId: 1,
            objectId: "0jZ0KfZxz8BQL8ZDATGOfF" // IfcStair
        },
        {
            linkId: 3,
            taskId: 2,
            objectId: "2xho8b5LT0bvdcb_$4vT1A" // ifcSlab
        },
        {
            linkId: 4,
            taskId: 3,
            objectId: "1nbTe5YC93De9Jqdh8$uRP" // "zinkwerk"
        }
    ];

    //----------------------------------------------------------------------------------------------------------------------
    // When model loaded, wind time through the tasks, highlighting objects linked to to each current task
    //----------------------------------------------------------------------------------------------------------------------

    model.on("loaded", () => {

        model.xrayed = true;

        var t = 0;
        var updates = null;

        setInterval(() => {
                if (updates) {
                    removeUpdates(updates);
                }
                updates = getUpdates(t);
                if (updates) {
                    applyUpdates(updates);
                }
                t += 0.1;
                if (t > 3.0) {
                    t = 0;
                }
            },
            200);
    });

    function getUpdates(t) {
        let updates = null;
        for (var i = 0, len = tasks.length; i < len; i++) {
            const task = tasks[i];
            if (task.start <= t && t <= task.end) {
                for (var j = 0, lenj = links.length; j < lenj; j++) {
                    const link = links[j];
                    if (task.id === link.taskId) {
                        const typeId = task.typeId;
                        const type = types[typeId];
                        const color = type.color;
                        const objectId = link.objectId;
                        const entity = viewer.scene.objects[objectId];
                        if (entity) {
                            if (!updates) {
                                updates = [];
                            }
                            const update = {
                                object: entity,
                                color: color
                            };
                            if (!updates) {
                                updates = [];
                            }
                            updates.push(update);
                        }
                    }
                }
            }
        }
        return updates;
    }

    function applyUpdates(updates) {
        for (var i = 0, len = updates.length; i < len; i++) {
            const update = updates[i];
            const entity = update.object;
            const color = update.color;
            entity.colorize = color;
            entity.xrayed = false;
        }
    }

    function removeUpdates(updates) {
        for (var i = 0, len = updates.length; i < len; i++) {
            const update = updates[i];
            const entity = update.object;
            entity.colorize = null;
            entity.xrayed = true;
        }
    }

</script>
</html>

